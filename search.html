<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Character Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/search.css">
</head>

<body>
  <div class="container-fluid header">
    <div class="h4">Character Search</div>
    <a href="index.html#menu"><button class="btn btn-secondary">Back</button></a>
  </div>

  <div class="container my-4">
    <div class="row">
      <div class="col">
        <div class="card shadow-sm rounded-3 p-3 mx-auto" style="max-width: 500px; color: #f8f7f7;">
          <div class="h5">Search Character</div>
          <div class="my-3">
            <label for="searchInput" class="form-label">Character name or ID (1 - 95)</label>
            <input class="form-control" id="searchInput" placeholder="e.g., 1 or Tanjiro Kamado">
          </div>
          <div class="mt-3">
            <button class="btn btn-info w-100" onclick="search()">Search</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="characterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="characterModalLabel">Character Name</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column flex-md-row gap-3">
          <img id="characterModalImage" src="" alt="" class="img-fluid rounded mb-3 mb-md-0">
          <div id="characterModalInfo">
            <p><strong>Role:</strong> <span id="characterModalRole"></span></p>
            <p><strong>Additional Info:</strong></p>
            <ul id="characterModalExtras" class="list-unstyled"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Demon Slayer Fan Page</p>
    <p style="color: #ff4d4d;">All characters belong to their creators. Fan-made page.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let animeCharacters = [];
    let localIdMap = {};

    async function loadAnimeCharacters() {
      try {
        const response = await fetch('https://api.jikan.moe/v4/anime/38000/characters');
        const data = await response.json();
        animeCharacters = data.data;
        animeCharacters.forEach((c, i) => localIdMap[i + 1] = c.character.mal_id);
      } catch {
        alert('Failed to load characters.');
      }
    }

    async function displayCharacter(malId, role) {
      const modal = new bootstrap.Modal(document.getElementById('characterModal'));
      const modalTitle = document.getElementById('characterModalLabel');
      const modalImage = document.getElementById('characterModalImage');
      const modalRole = document.getElementById('characterModalRole');
      const modalExtras = document.getElementById('characterModalExtras');

      modalTitle.textContent = 'Loading...';
      modalImage.src = '';
      modalRole.textContent = '';
      modalExtras.innerHTML = '';
      modal.show();

      try {
        const res = await fetch(`https://api.jikan.moe/v4/characters/${malId}/full`);
        const charData = (await res.json()).data;

        modalTitle.textContent = charData.name;
        modalImage.src = charData.images.jpg.image_url;
        modalRole.textContent = role;

        modalExtras.innerHTML = '';

        if (charData.about) {
          const paragraphs = charData.about.split('\n').join('. ').split('. ').filter(Boolean);
          paragraphs.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = p.trim() + '.';
            modalExtras.appendChild(li);
          });
        }

        if (charData.nicknames.length) {
          const li = document.createElement("li");
          li.innerHTML = `<strong>Nicknames:</strong> ${charData.nicknames.join(', ')}`;
          modalExtras.appendChild(li);
        }

      } catch {
        modalTitle.textContent = 'Failed to load info';
        modalExtras.innerHTML = `<li class="text-danger">Error fetching data</li>`;
      }
    }

    function search() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      let found = null;
      if (!isNaN(query)) {
        const id = Number(query);
        if (id >= 1 && id <= animeCharacters.length) found = animeCharacters[id - 1];
      } else {
        found = animeCharacters.find(c => c.character.name.toLowerCase().includes(query.toLowerCase()));
      }

      if (found) displayCharacter(found.character.mal_id, found.role);
      else alert('Character not found.');
    }

    loadAnimeCharacters();
  </script>
</body>

</html>
